#!/bin/bash
# Pre-push hook to auto-increment build number
# Only triggers if sms_automatisation.js has changed

# Path to files
BUILD_FILE=".build_number"
SCRIPT_SOURCE="app/sms_automatisation.js"
VERSION_JSON="version.json"

# Check if sms_automatisation.js is being pushed (in the commits being pushed)
# Get the range of commits being pushed
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch, check all commits
        RANGE="$local_sha"
    else
        RANGE="$remote_sha..$local_sha"
    fi
    
    # Check if any commit in the range changes sms_automatisation.js
    if git diff --name-only "$RANGE" 2>/dev/null | grep -q "sms_automatisation.js\|app/sms_automatisation.js"; then
        SCRIPT_CHANGED=true
        break
    fi
done

if [ "$SCRIPT_CHANGED" != "true" ]; then
    echo "â„¹ï¸  No changes to sms_automatisation.js - skipping version increment"
    exit 0
fi

echo "ðŸ“± Mobile script changed - incrementing build number..."

# Read current build number or start at 0
if [ -f "$BUILD_FILE" ]; then
    BUILD=$(cat "$BUILD_FILE")
else
    BUILD=0
fi

# Increment build number
BUILD=$((BUILD + 1))
echo $BUILD > "$BUILD_FILE"

# Get base version from script (e.g., "1.0")
BASE_VERSION=$(grep 'const SCRIPT_VERSION' "$SCRIPT_SOURCE" | sed 's/.*"\([0-9]*\.[0-9]*\).*/\1/')

# Update script with new full version
FULL_VERSION="${BASE_VERSION}.${BUILD}"
sed -i '' "s/const SCRIPT_VERSION = \"[^\"]*\"/const SCRIPT_VERSION = \"$FULL_VERSION\"/" "$SCRIPT_SOURCE"

# Update version.json
CHANGELOG=$(cat "$VERSION_JSON" 2>/dev/null | grep '"changelog"' | sed 's/.*: *"\(.*\)".*/\1/' || echo "Build $BUILD")
cat > "$VERSION_JSON" << EOF
{
    "version": "$FULL_VERSION",
    "changelog": "$CHANGELOG",
    "date": "$(date +%Y-%m-%d)",
    "build": $BUILD
}
EOF

# Copy updated script to root
cp "$SCRIPT_SOURCE" "sms_automatisation.js"

# Add the changed files to the commit
git add "$BUILD_FILE" "$SCRIPT_SOURCE" "$VERSION_JSON" "sms_automatisation.js"
git commit --amend --no-edit

echo "âœ… Build number incremented to $BUILD (version $FULL_VERSION)"
